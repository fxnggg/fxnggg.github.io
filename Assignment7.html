<html>
<head>
	<title>BunBun's Adventures</title>
	<meta charset="UTF-8">
<link href = 'https://fonts.googleapis.com/css?family=Amatic SC' rel = 'stylesheet'>
<style>
	body
	{
		background-color: #dbf2f8;
	}
	h1
	{
		padding-top: 20px;
		font-family: 'Amatic SC';
		font-size: 50px;
		text-align: center;
		color: white;
		text-shadow: 2px 1px #000000;
		margin-bottom: 10px;
	}
	
	p
	{
		margin: auto;
		text-align: center;
		width: 1000px;
		font-size: 16px;
	}
</style>
</head>
<body>
<p>
	
	
</p>
<h1>BunBun's Adventures</h1>
<p>Welcome to BunBun's Adventures! Use the left and right arrows to move. To jump, use the up arrow or the spacebar. To shoot fireballs at the enemies, hit the control button. For music and sound effects, click on the music button in the top right corner of the game. For best user experience, play in full screen.</p>
<br>
<canvas id="myCanvas" width="1000" height="600" style="border:1px solid #cccccc;"></canvas>

<script type="text/javascript">

class Sprite
{
	constructor(x, y, width, height, type)
	{
		this.x = x;
		this.y = y;
		this.image = new Image();
	}
	
	drawYourself()
	{
		
	}
	
	spriteCollide(a)
	{
		let callingSpriteRight = this.x + this.width;
		let callingSpriteLeft = this.x;
		let checkCollisionSpriteRight = a.x + a.width;
		let checkCollisionSpriteLeft = a.x;
		let callingSpriteHead = this.y;
		let callingSpriteToes = this.y + this.height;
		let checkCollisionSpriteTop = a.y;
		let checkCollisionSpriteBottom = a.y + a.height;
		
		if(callingSpriteRight < checkCollisionSpriteLeft)
			return false;
		if(callingSpriteLeft > checkCollisionSpriteRight)
			return false;
		if(callingSpriteToes < checkCollisionSpriteTop)
			return false;
		if(callingSpriteHead > checkCollisionSpriteBottom)
			return false;
		
		return true;
	}
}

class Tube extends Sprite
{
	constructor(x, y, m)
	{
		super(x, y, 55, 400, "tube");
		this.x = x;
		this.y = y;
		this.model = m;
		
		this.type = "tube";
		
		this.tubeImage = new Image();
		
		this.width = 55;
		this.height = 400;
		
		this.loadTubeImage();
		
		this.canvas = document.getElementById("myCanvas");
	}
	
	update()
	{
	
	}
	
	loadTubeImage()
	{
		this.tubeImage.src = "tube.png";
	}
	
	drawYourself()
	{
		let ctx = this.canvas.getContext("2d");
		ctx.drawImage(this.tubeImage, this.x - this.model.bunny.x + this.model.bunny.bunnyOffset, this.y);
	}
	
	clickedOnATube(mouseX, mouseY)
	{
		if(mouseX < this.x)
			return false;
			
		if(mouseX > this.x + this.width)
			return false;
			
		if(mouseY < this.y)
			return false;
			
		if(mouseY > this.y + this.height)
			return false;

		return true;
	}
}

class Bunny extends Sprite
{
	constructor(x, y)
	{
		super(x, y, 45, 68, "bunny");
		this.x = x;
		this.y = y;
		this.width = 45;
		this.height = 68;
		this.bunnyImageNum = 0;
		this.vert_vel = 12.0;
		this.countFrame = 0;
		this.bunnyOffset = 100;
		this.flip = false;
		this.type = "bunny";
			
		this.bunnyImages = new Array();
		
		this.bunnyImages[0] = new Image();
		this.bunnyImages[0].src = "bunny1.png";	

		this.bunnyImages[1] = new Image();
		this.bunnyImages[1].src = "bunny2.png";
		
		this.bunnyImages[2] = new Image();
		this.bunnyImages[2].src = "bunny3.png";
		
		this.bunnyImages[3] = new Image();
		this.bunnyImages[3].src = "bunny4.png";
		
		this.grounded = true;
		
		this.flipImages = new Array();
		
		this.flipImages[0] = new Image();
		this.flipImages[0].src = "flipbunny1.png";
		
		this.flipImages[1] = new Image();
		this.flipImages[1].src = "flipbunny2.png";
		
		this.flipImages[2] = new Image();
		this.flipImages[2].src = "flipbunny3.png";
		
		this.flipImages[3] = new Image();
		this.flipImages[3].src = "flipbunny4.png";

		
		this.canvas = document.getElementById("myCanvas");
		this.ctx = this.canvas.getContext("2d");
		
		this.mySound = new Audio("jump.mp3");
		this.walk = new Audio("walk.mp3");
		
		this.backgroundMusic = false;
	}
	
	getOutOfTube(t)
	{
		let bunnyRight = this.x + this.width;
		let bunnyLeft = this.x;
		let tubeRight = t.x + t.width;
		let tubeLeft = t.x;
		let bunnyHead = this.y;
		let bunnyToes = this.y + this.height;
		let tubeTop = t.y;
		let tubeBottom = t.y + t.height;
		
		// In the tube, but previously on left side
		if(bunnyRight >= tubeLeft && this.prevX + this.width <= tubeLeft)
		{
			this.x = t.x - this.width;
		}
		
		// In the tube, but previously on right side
		if (bunnyLeft <= tubeRight && this.prevX >= tubeRight)
		{
			this.x = tubeRight;
		}

		// In the tube, but previously above the tube
		if(bunnyToes >= tubeTop && this.prevY + this.height <= tubeTop)
		{
			this.y = t.y - this.height;
			this.vert_vel = 0;
			this.countFrame = 0; 
			this.grounded  = true; 
		}
		
		// In the tube, but previously below the tube
		if(bunnyHead <= tubeBottom && this.prevY >= tubeBottom)
		{
			this.y = tubeBottom;
			this.vert_vel = 0;
		}
	}
	
	drawYourself()
	{	
		// Bunny facing left, not moving
		if(this.flip && this.x == this.prevX)
		{
			this.ctx.drawImage(this.flipImages[0], this.bunnyOffset + this.width, this.y, -this.width, this.height);
		}
		// Bunny facing right, not moving
		else if(this.x == this.prevX)
		{
			this.ctx.drawImage(this.bunnyImages[0], this.bunnyOffset, this.y, this.width, this.height);
		}
		// Bunny facing left, moving
		else if (this.flip)
		{
			this.ctx.drawImage(this.flipImages[this.bunnyImageNum], this.bunnyOffset + this.width, this.y, -this.width, this.height);
		}
		
		// Bunny facing right, moving
		else
		{
			this.ctx.drawImage(this.bunnyImages[this.bunnyImageNum], this.bunnyOffset, this.y, this.width, this.height);
		}
			
	}
	
	update()
	{
		this.bunnyImageNum++;
		this.countFrame++;

		if(this.bunnyImageNum > 3)
		{
			this.bunnyImageNum = 0;
		}
		
		this.vert_vel += 3;
		this.y += this.vert_vel;
		
		if(this.y > 435)
		{
			this.vert_vel = 0.0;
			this.y = 435; // snap back to the ground
			this.countFrame = 0;
			this.grounded = true;
		}
		
		if(this.y < 0)
		{
			this.y = 0;
		}
	}
	
	savePreviousCoordinates()
	{
		this.prevX = this.x;
		this.prevY = this.y;
	}
	
	jump()
	{
		if(this.countFrame < 5)
		{
			this.vert_vel -= 10;
			this.grounded = false;
		}
	}
}

class Devil extends Sprite
{
	constructor(x, y, m)
	{
		super(x, y, 52, 49, "devil")
		this.x = x;
		this.y = y;
		this.model = m;
		this.width = 52;
		this.height = 49;
		this.move = true;

		this.type = "devil";
		
		this.speed = 7;
		this.direction = -1;
		
		this.isOnFire = false;
		this.count = 1;
		
		this.image = new Image();
		this.dying = new Image();
		
		this.image.src = "devil.png";
		this.dying.src = "devil_fire.png";
		
		this.canvas = document.getElementById("myCanvas");
		
		this.mySound = new Audio("dead.mp3");
	}

	
	update()
	{
		this.prevX = this.x;
		this.prevY = this.y;
	
		// Move devil
		if(this.move)
			this.x += this.speed * this.direction;
		
		// Count how long devil has been on fire
		if(this.isOnFire)
		{
			this.count++;
		}
		
		for(let i = 0; i < this.model.sprites.length; i++)
		{				
			// Check for collision with tube
			if(this.model.sprites[i].type == "tube")
			{
				let t = new Tube(this.model.sprites[i]);
				
				// Check collision with tube
				if(this.spriteCollide(t))
				{
					let devilRight = this.x + this.width;
					let devilLeft = this.x;
					let tubeRight = t.x.x + t.width;
					let tubeLeft = t.x.x;
					
					// Devil moves left
					if(devilRight >= tubeLeft && this.prevX + this.width <= tubeLeft)
					{
						this.direction = -1;
					}

					// Devil moves right
					if(devilLeft <= tubeRight && this.prevX >= tubeRight)
					{
						this.direction = 1;
					}
				}
			}
			
			// Check collision with fireball
			if(this.model.sprites[i].type == "fireball")
			{

				let f = new Fireball(this.model.sprites[i]);
				if(this.collide(f))
				{
					if(this.model.bunny.backgroundMusic)
					{
						this.mySound.play();
						this.mySound.volume = 0.8;
					
						//if(this.mySound.currentTime == 0)
							//this.isOnFire = true;
					}
					this.isOnFire = true;
				}
			}
			
			// Check if devil is on fire
			if(this.model.sprites[i].type == "devil")
			{
				if(this.isOnFire)
				{
					// Devil stays in place as its on fire
					this.x = this.prevX;
					
					// Remove dead devil
					if(this.count >= 55)
					{
						this.model.sprites[i].dying.visibility = false;
						this.model.sprites.splice(i, 1);
						this.count = 0;
					}
				}
			}
			
		}
	}
	
	drawYourself()
	{
		let ctx = this.canvas.getContext("2d");
		if(this.isOnFire)
			ctx.drawImage(this.dying, this.x - this.model.bunny.x + this.model.bunny.bunnyOffset, this.y);
		else
			ctx.drawImage(this.image, this.x - this.model.bunny.x + this.model.bunny.bunnyOffset, this.y);
	}
	
	
	// Collision detection
	collide(t)
	{
		let devilRight = this.x + this.width;
		let devilLeft = this.x;
		let tubeRight = t.x.x + t.x.width;
		let tubeLeft = t.x.x;
		let devilHead = this.y;
		let devilToes = this.y + this.height;
		let tubeTop = t.x.y;
		let tubeBottom = t.x.y + t.x.height;
		
		if(devilRight < tubeLeft)
			return false;
		if(devilLeft > tubeRight)
			return false;
		if(devilToes < tubeTop)
			return false;
		if(devilHead > tubeBottom)
			return false;
		
		return true;
	}
	
}

class Fireball extends Sprite
{
	constructor(x, y, m)
	{
		super(x, y, 47, 47, "fireball");
		this.x = x;
		this.y = y;
		
		this.width = 47;
		this.height = 47;
		
		this.type = "fireball";
		this.onScreen = true;
	
		this.model = m;
		this.vert_vel = 12.0;
		
		this.image = new Image();
		this.image.src = "fireball.png";
		
		this.canvas = document.getElementById("myCanvas");
		
		this.mySound = new Audio("fireball.mp3");
	}
	
	update()
	{
		this.vert_vel += 3;
		this.y += this.vert_vel;
		
		// Fireball bounces
		if(this.y > 440)
		{
			this.vert_vel -= 25;
		}
		
		// Fireball doesn't go above screen
		if(this.y < 0)
		{
			this.y = 0;
		}
		
		if(this.y > 455)
		{
			this.y = 455;
		}
		
		
		// Move fireball forward
		this.x += 15;
	}
	
	drawYourself()
	{
		let ctx = this.canvas.getContext("2d");
		ctx.drawImage(this.image, this.x - this.model.bunny.x + this.model.bunny.bunnyOffset, this.y);
	}
}


class Snow
{
	constructor()
	{
		this.canvas = document.getElementById("myCanvas");
		this.ctx = this.canvas.getContext("2d");
		
		let canvasW = 1000;
		let canvasH = 600;
		
		this.snowflakes = [];
	}
	
	initializeSnow()
	{
		let animateInterval = setInterval(this.animate(), 30);
	}
	
	addSnowflake()
	{
		let x = Math.floor(Math.random() * 1000 + 1);
		let y = 0;
		let s = Math.floor(Math.random() * 3) + 1;
		
		this.snowflakes.push({"x":x, "y":y, "s":s});
		
	}
	
	snowFall()
	{
		this.addSnowflake();
		this.addSnowflake();
		for(let i = 0; i < this.snowflakes.length; i++)
		{
			this.ctx.fillStyle = "white";
			this.ctx.beginPath();
			this.ctx.arc(this.snowflakes[i].x, this.snowflakes[i].y += this.snowflakes[i].s * 0.5, this.snowflakes[i].s * 0.5, 0, Math.PI * 2, false);
			this.ctx.fill();
		
			if(this.snowflakes[i].y > 500)
				this.snowflakes.splice(i, 10);
			
		}
	}
	
	animate()
	{
		this.ctx.save();
		this.ctx.clearRect(0, 0, this.canvasW, this.canvasH);
		this.snowFall();
		this.ctx.restore();
	}
}


class Model
{
	constructor()
	{
		this.sprites = [];
		this.bunny = new Bunny(100, 50);
		this.bunny.x = 100;
		this.bunny.bunnyOffset = 100;
		
		this.sprites.push(this.bunny);
		
		this.sprites.push(new Tube(282, 424, this));
		this.sprites.push(new Tube(383, 360, this));
		this.sprites.push(new Tube(784, 357, this));
		this.sprites.push(new Tube(904, 400, this));
		this.sprites.push(new Tube(1008, 298, this));
		this.sprites.push(new Tube(1462, 295, this));
		this.sprites.push(new Tube(1591, 348, this));
		this.sprites.push(new Tube(1724, 291, this));
		this.sprites.push(new Tube(1884, 324, this));
		this.sprites.push(new Tube(2280, 328, this));
		this.sprites.push(new Tube(2401, 260, this));
		this.sprites.push(new Tube(2509, 330, this));
		
		this.sprites.push(new Devil(550, 455, this));
		this.sprites.push(new Devil(2242, 455, this));
		
	}
	
	
	update()
	{
		for(let i = 0; i < this.sprites.length; i++)
		{
			this.sprites[i].update();
			
			if(this.sprites[i].type == "tube")
			{
				let t = new Tube(this.sprites[i].x, this.sprites[i].y, this);
				
				// Check Bunny collision with tube
				if(this.bunny.spriteCollide(t))
				{
					console.log('bunny x: ' + this.bunny.x);
					console.log('tube x: ' + t.x);
					this.bunny.getOutOfTube(t);
				}
			}
			
			// Remove fireball from sprites once its offscreen
			if(this.sprites[i].type == "fireball")
			{
				if(this.sprites[i].x > 1000 + this.bunny.x + this.bunny.bunnyOffset)
						this.sprites.splice(i, 1);
			}
		}
	}
	
	addOrRemoveTube(mouseX, mouseY)
	{
		let haveIClickedOnATube = false;
		let tube = null;
		for(let i = 0; i < this.sprites.length; i++)
		{
			if(this.sprites[i].isTube())
			{
				tube = new Tube(sprites[i]);
				if(tube.clickedOnATube(mouseX, mouseY))
				{
					this.sprites.splice(i, 1);
					haveIClickedOnATube = true;
				}
			}
		}
		
		if(!haveIClickedOnATube)
		{
			let t = new Tube(mouseX, mouseY, this);
			t.x = mouseX;
			t.y = mouseY;
			this.sprites.push(t);
		}

	}
}

class View
{
	constructor(c, m, t)
	{
		this.controller = c;
		this.model = m;
		this.tube = t;
		this.snow = new Snow();
		this.canvas = document.getElementById("myCanvas");
		this.background = new Image();
		this.background.src = "background.png";
		this.groundPos = 350;
		this.ground = new Image();
		this.ground.src = "ground.png";
		
		this.soundImage = new Image();
		this.soundImage.src = "mute.png";
		
		this.soundOn = true;
		
		this.mySound = new Audio("first-date.mp3");
		
		let bunnyPosIncrement = false; 
		
		this.ctx = this.canvas.getContext("2d");
		this.style = this.canvas.style;
		this.style.marginLeft = "auto";
		this.style.marginRight = "auto";
		this.parentStyle = this.canvas.parentElement.style;
		this.parentStyle.textAlign = "center";
		this.parentStyle.width = "99%";
		
		this.fullscreen = new Image();
		this.fullscreen.src = "fullscreen.png";
		
		this.full = false;
		
	}
	
	//Previously paintComponent
	update()
	{
		this.ctx.fillRect(0, 0, 1000, this.canvas.height);
		
		if(this.bunnyPosIncrement)
		{
			this.ctx.fillRect(0, 0, this.model.bunny.x + 1000, 600);
		}
		
		if(!this.bunnyPosIncrement)
		{
			this.ctx.fillRect(0, 0, this.model.bunny.x - 1000, 600);
		}
		
		this.ctx.drawImage(this.background, 0, 0);
		this.ctx.drawImage(this.ground, 0, this.groundPos);
		
		for(let i = 0; i < this.model.sprites.length; i++)
		{
			let sprite = this.model.sprites[i];
			sprite.drawYourself();
		}
		this.snow.initializeSnow();
		this.ctx.drawImage(this.soundImage, 940, 10);	
		this.ctx.drawImage(this.fullscreen, 936, 536);
		
			
	}
	
	playSound()
	{
		
		if(this.soundOn)
		{
			this.soundImage.src = "sound.png";
			this.soundOn = false;
			this.mySound.play();
			if(this.mySound.currentTime >= 30)
				this.mySound.volume = 0.5;
			else
				this.mySound.volume = 0.7;
			
			this.model.bunny.backgroundMusic = true;
		}
		else
		{
			this.soundImage.src = "mute.png";
			this.soundOn = true;
			this.mySound.pause();
			
			this.model.bunny.backgroundMusic = false;
		}
	}
	
	fullScreen()
	{
		let e =  document.documentElement;
		
		let isInFullScreen = (document.fullscreenElement && document.fullscreenElement !== null) 
							|| (document.webkitFullscreenElement && document.webkitFullscreenElement !== null)
							|| (document.msFullscreenElement && document.msFullscreenElement !== null);
			
		if(this.full)
		{
			this.fullscreen.src = "fullscreen.png";
			this.full = false;
  			if(e.requestFullscreen)
  				e.requestFullscreen();
  			else if (e.webkitRequestFullscreen) 
  			    e.webkitRequestFullscreen();
  			else if (e.msRequestFullscreen) 
  			    e.msRequestFullscreen();
		}
		else
		{
			this.fullscreen.src = "exit.png";
			this.full = true;
		}
		
		if(!isInFullScreen)
		{  
  			if(e.requestFullscreen)
  				e.requestFullscreen();
  			else if (e.webkitRequestFullscreen)
  			    e.webkitRequestFullscreen();
  			else if (e.msRequestFullscreen) 
  			    e.msRequestFullscreen();
		}
		else
		{
			if (document.exitFullscreen)
			    document.exitFullscreen();
			else if (document.webkitExitFullscreen)
			    document.webkitExitFullscreen();
			else if (document.msExitFullscreen)
			    document.msExitFullscreen();
		}
		
		
	}
	
}

class Controller
{
	constructor(model, view)
	{
		this.model = model;
		this.view = view;
		this.snow  = new Snow();
		this.key_right = false;
		this.key_left = false;
		this.key_up = false;
		this.key_down = false;
		this.spacebar = false;
		this.soundOn = false;
		
		let self = this;
		view.canvas.addEventListener("click", function(event) { self.onClick(event); });
		document.addEventListener('keydown', function(event) { self.keyDown(event); }, false);
		document.addEventListener('keyup', function(event) { self.keyUp(event); }, false);
		
		window.addEventListener('load', function(event) { self.load(event); });
		
	}
	
	load(event)
	{
		this.snow.initializeSnow();
	}
	
	onClick(event)
	{	
		let rect = this.view.canvas.getBoundingClientRect(); 
		let canvasX = event.clientX - rect.left; 
		
		let canvasY = event.clientY - rect.top; 
	
		let x = this.view.canvas.width - canvasX;
		let y = this.view.canvas.height - canvasY;
	
		if(x <= 65 && canvasY <= 65)
		{
			//this.soundOn = true;
			this.view.playSound();
		}
		
		if(x <= 65 && y <= 65)
		{
			this.view.fullScreen();
			if(this.view.fullscreen.src == "fullscreen.png")
				this.view.full = true;
			else if(this.view.fullscreen.src == "exit.png")
				this.view.full = false;
		}
	
		
	}
	
	keyDown(event)
	{
		if(event.keyCode == 39) this.key_right = true;
		else if(event.keyCode == 37) this.key_left = true;
		else if(event.keyCode == 38) this.key_up = true;
		else if(event.keyCode == 40) this.key_down = true;
		else if(event.keyCode == 32) this.spacebar = true;
		else if(event.keyCode == 17)
		{
			// Only shoot fireballs if bunny is facing right
			if(!this.model.bunny.flip)
			{
				this.model.sprites.push(new Fireball(this.model.bunny.x + (this.model.bunny.width * 0.5), this.model.bunny.y + (this.model.bunny.height * 0.5), this.model));
				let f = this.model.sprites[this.model.sprites.length-1];
				if(!this.view.mySound.paused)
				{
					f.mySound.play();
					f.mySound.volume = 0.4;
				}
			}
		}
	}
	
	keyUp(event)
	{
		if(event.keyCode == 39) this.key_right = false;
		else if(event.keyCode == 37) this.key_left = false;
		else if(event.keyCode == 38) this.key_up = false;
		else if(event.keyCode == 40) this.key_down = false;
		else if(event.keyCode == 32) this.spacebar = false;
	}
	
	update()
	{
		this.model.bunny.savePreviousCoordinates();
		
		if(this.key_right)
		{
			this.model.bunny.x += 10;
			this.view.bunnyPosIncrement  = true;
			this.model.bunny.flip = false;
			if(this.model.bunny.grounded)
			{
				if(!this.view.mySound.paused)
					this.model.bunny.walk.play();
			}
		}
		
		if(this.key_left)
		{
			this.model.bunny.x -= 10;
			this.view.bunnyPosIncrement = false;
			this.model.bunny.flip = true;
			if(this.model.bunny.grounded)
			{
				if(!this.view.mySound.paused)
					this.model.bunny.walk.play();
			}
		}
		
		if(this.key_up || this.spacebar)
		{
			if(!this.view.mySound.paused)
			{
				this.model.bunny.mySound.play();
				this.model.bunny.mySound.volume = 0.6;
			}
			this.model.bunny.jump();
		}
		
	}
	
}

class Game
{
	constructor()
	{
		this.model = new Model();
		this.tube = new Tube(0, 0, this.model);
		this.view = new View(this.controller, this.model, this.tube);
		this.controller = new Controller(this.model, this.view);
	}
	
	onTimer()
	{
		this.model.update();
		this.view.update();
		this.controller.update();
	}
	
}
	

let game = new Game();
let timer = setInterval(function() { game.onTimer(); }, 40);	

	
	
</script>

</body>
</html>
